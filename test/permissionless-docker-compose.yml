version: "3.5"
networks:
  default:
    name: zkevm
services:

  # TODO: remove this and use the permissionless sequencer
  zkevm-sequencer:
    container_name: zkevm-sequencer
    image: ghcr.io/espressosystems/zkevm-node:hotshot-integration
    ports:
      - 9092:9091 # needed if metrics enabled
    environment:
      - ZKEVM_NODE_STATEDB_HOST=zkevm-state-db
      - ZKEVM_NODE_POOL_HOST=zkevm-pool-db
    volumes:
      - ./test.keystore:/pk/keystore
      - ./config/test.node.config.toml:/app/config.toml
      - ./config/test.genesis.config.json:/app/genesis.json
    command:
      - "/bin/sh"
      - "-c"
      - "/app/zkevm-node run --genesis /app/genesis.json --cfg /app/config.toml --components sequencer"
    depends_on:
      zkevm-sync: # synchronizer runs state DB migrations
        condition: service_started
      zkevm-json-rpc: # let the JSON rpc run the pool DB migrations
        condition: service_healthy

  zkevm-json-rpc:
    container_name: zkevm-json-rpc
    image: ghcr.io/espressosystems/zkevm-node:hotshot-integration
    ports:
      - 8123:8123
      - 8133:8133 # needed if WebSockets enabled
      - 9091:9091 # needed if metrics enabled
    environment:
      - ZKEVM_NODE_STATEDB_HOST=zkevm-state-db
      - ZKEVM_NODE_POOL_HOST=zkevm-pool-db
      - ZKEVM_NODE_RPC_BROADCASTURI=zkevm-broadcast:61090
    volumes:
      - ./test.keystore:/pk/keystore
      - ./config/test.node.config.toml:/app/config.toml
      - ./config/test.genesis.config.json:/app/genesis.json
    command:
      - "/bin/sh"
      - "-c"
      - "/app/zkevm-node run --genesis /app/genesis.json --cfg /app/config.toml --components rpc"
    depends_on:
      zkevm-mock-l1-network:
        condition: service_started
      zkevm-sync: # synchronizer runs state DB migrations
        condition: service_started
      zkevm-pool-db:
        condition: service_healthy
    healthcheck:
      # curl not installed in container, but wget is
      test: ["CMD-SHELL", "wget", "http://localhost:8123", "-q", "-O", "/dev/null"]
      interval: 10s
      timeout: 5s
      retries: 5

  # zkevm-non-sequencer-json-rpc:
  #   container_name: zkevm-non-sequencer-json-rpc
  #   image: ghcr.io/espressosystems/zkevm-node:hotshot-integration
  #   ports:
  #     - 8125:8125
  #   environment:
  #     - ZKEVM_NODE_STATEDB_HOST=zkevm-state-db
  #     - ZKEVM_NODE_POOL_HOST=zkevm-pool-db
  #     - ZKEVM_NODE_RPC_SEQUENCERNODEURI=http://zkevm-json-rpc:8123
  #   volumes:
  #     - ./config/test.node.config.toml:/app/config.toml
  #     - ./config/test.genesis.config.json:/app/genesis.json
  #   command:
  #     - "/bin/sh"
  #     - "-c"
  #     - "/app/zkevm-node run --genesis /app/genesis.json --cfg /app/config.toml --components rpc"
  #   depends_on:
  #     - zkevm-state-db
  #     - zkevm-pool-db
  #     - zkevm-json-rpc

  zkevm-aggregator:
    container_name: zkevm-aggregator
    image: ghcr.io/espressosystems/zkevm-node:hotshot-integration
    ports:
      - 50081:50081
      - 9093:9091 # needed if metrics enabled
    environment:
      - ZKEVM_NODE_STATEDB_HOST=zkevm-state-db
    volumes:
      - ./test.keystore:/pk/keystore
      - ./config/test.node.config.toml:/app/config.toml
      - ./config/test.genesis.config.json:/app/genesis.json
    command:
      - "/bin/sh"
      - "-c"
      - "/app/zkevm-node run --genesis /app/genesis.json --cfg /app/config.toml --components aggregator"
    depends_on:
      - zkevm-sync # zkevm-sync runs state DB migrations


  zkevm-sync:
    container_name: zkevm-sync
    image: ghcr.io/espressosystems/zkevm-node:hotshot-integration
    environment:
      - ZKEVM_NODE_STATEDB_HOST=zkevm-state-db
    volumes:
      - ./test.keystore:/pk/keystore
      - ./config/test.node.config.toml:/app/config.toml
      - ./config/test.genesis.config.json:/app/genesis.json
    command:
      - "/bin/sh"
      - "-c"
      - "/app/zkevm-node run --genesis /app/genesis.json --cfg /app/config.toml --components synchronizer"
    depends_on:
      zkevm-state-db:
        condition: service_healthy
      zkevm-mock-l1-network:
        condition: service_started

  # zkevm-broadcast:
  #   container_name: zkevm-broadcast
  #   image: ghcr.io/espressosystems/zkevm-node:hotshot-integration
  #   environment:
  #     - ZKEVM_NODE_STATEDB_HOST=zkevm-state-db
  #   ports:
  #     - 61090:61090
  #   volumes:
  #     - ./test.keystore:/pk/keystore
  #     - ./config/test.node.config.toml:/app/config.toml
  #     - ./config/test.genesis.config.json:/app/genesis.json
  #   command:
  #     - "/bin/sh"
  #     - "-c"
  #     - "sleep 5 && /app/zkevm-node run --genesis /app/genesis.json --cfg /app/config.toml --components broadcast-trusted-state"
  #   depends_on:
  #     zkevm-state-db:
  #       condition: service_healthy

  zkevm-state-db:
    container_name: zkevm-state-db
    image: postgres
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    ports:
      - 5432:5432
    volumes:
      - ../db/scripts/init_prover_db.sql:/docker-entrypoint-initdb.d/init.sql
    environment:
      - POSTGRES_USER=state_user
      - POSTGRES_PASSWORD=state_password
      - POSTGRES_DB=state_db
    command: ["postgres", "-N", "500"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready", "-U", "state_user"]
      interval: 10s
      timeout: 5s
      retries: 5

  zkevm-pool-db:
    container_name: zkevm-pool-db
    image: postgres
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    ports:
      - 5433:5432
    environment:
      - POSTGRES_USER=pool_user
      - POSTGRES_PASSWORD=pool_password
      - POSTGRES_DB=pool_db
    command: ["postgres", "-N", "500"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready"]
      interval: 10s
      timeout: 5s
      retries: 5

  zkevm-mock-l1-network:
    container_name: zkevm-mock-l1-network
    image: ghcr.io/espressosystems/geth-zkevm-contracts:hotshot-integration
    ports:
      - 8545:8545
      - 8546:8546
    command: ["--http", "--http.api", "admin,eth,debug,miner,net,txpool,personal,web3",  "--http.addr", "0.0.0.0","--http.corsdomain", "*", "--http.vhosts" ,"*", "--ws", "--ws.origins", "*", "--ws.addr", "0.0.0.0", "--dev", "--datadir", "/geth_data", "--syncmode", "full"]

  zkevm-prover:
    container_name: zkevm-prover
    image: hermeznetwork/zkevm-prover@sha256:ca123e5d23b38ac27c4b32c3a6c92ee7c988beb2f2405369e7065b0d63601245
    ports:
      # - 50051:50051 # Prover
      - 50052:50052 # Mock prover
      - 50061:50061 # MT
      - 50071:50071 # Executor
    volumes:
      - ./config/test.prover.config.json:/usr/src/app/config.json
    command: >
      zkProver -c /usr/src/app/config.json
    depends_on:
      - zkevm-sync # zkevm-sync runs state DB migrations

  # zkevm-permissionless-db:
  #   container_name: zkevm-permissionless-db
  #   image: postgres
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 2G
  #       reservations:
  #         memory: 1G
  #   ports:
  #     - 5437:5432
  #   environment:
  #     - POSTGRES_USER=test_user
  #     - POSTGRES_PASSWORD=test_password
  #     - POSTGRES_DB=test_db
  #   command: ["postgres", "-N", "500"]

  # zkevm-permissionless-node:
  #   container_name: zkevm-permissionless-node
  #   image: ghcr.io/espressosystems/zkevm-node:hotshot-integration
  #   ports:
  #     - 8126:8126
  #   environment:
  #     - ZKEVM_NODE_TRUSTED=false
  #     - ZKEVM_NODE_STATEDB_USER=test_user
  #     - ZKEVM_NODE_STATEDB_PASSWORD=test_password
  #     - ZKEVM_NODE_STATEDB_NAME=state_db
  #     - ZKEVM_NODE_STATEDB_HOST=zkevm-permissionless-db
  #     - ZKEVM_NODE_POOL_USER=test_user
  #     - ZKEVM_NODE_POOL_PASSWORD=test_password
  #     - ZKEVM_NODE_POOL_NAME=pool_db
  #     - ZKEVM_NODE_POOL_HOST=zkevm-permissionless-db
  #     - ZKEVM_NODE_RPC_PORT=8126
  #   volumes:
  #     - ./test.keystore:/pk/keystore
  #     - ./config/test.node.config.toml:/app/config.toml
  #     - ./config/test.genesis.config.json:/app/genesis.json
  #     - ./config/single_db_server.sql:/docker-entrypoint-initdb.d/init.sql
  #   command:
  #     - "/bin/sh"
  #     - "-c"
  #     - "/app/zkevm-node run --genesis /app/genesis.json --cfg /app/config.toml --components \"rpc,synchronizer\""
  #   depends_on:
  #     - zkevm-permissionless-db
